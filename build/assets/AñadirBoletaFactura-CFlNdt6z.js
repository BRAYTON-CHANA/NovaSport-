import{r as s,u as ne,v as re,b as S,j as e}from"./index-g1PumTm4.js";import{S as ie,H as le}from"./Header-HN8A8OWr.js";import{F as ce,a as de}from"./Fase3Garantias-CnNAM-Yo.js";import{G as me}from"./GestionCodigosModal-D5Hp2JG-.js";import{G as ue}from"./GestionInstalacionesModal-D1O17sLp.js";import"./index.es-CE8XIQIh.js";import"./floating-ui.react-dom-CY_ef83B.js";import"./index-Ei0h8sv0.js";const T="INGRESOS POR FONDOS DE GARANTIA",xe="00-000-860212";function Ae(){const[y,k]=s.useState(!1),{database:o,agregarBoletaCompleta:D}=ne(),I=re(),[b,h]=s.useState(1),[p,R]=s.useState(!1),[f,w]=s.useState(!1),[P,L]=s.useState(""),[B,U]=s.useState(""),[t,N]=s.useState({NroRecibo:"",NroDocumento:"",Documento:"Boleta",Fecha:new Date().toISOString().slice(0,10),AlquiladoA:"",Instalacion:"",Descripcion:"",Categoria:"",Subcategoria:"",cuentaContableId:null,CuentaCorriente:"00-000-283118",Anulado:!1}),[j,M]=s.useState([]),[A,$]=s.useState(!1),[E,q]=s.useState({descripcion:"",dirigidoA:"",cuentaCorriente:xe}),[C,_]=s.useState([]),[H,V]=s.useState([]),[z,J]=s.useState([]),[G,K]=s.useState([]),[m,Q]=s.useState(""),[d,W]=s.useState(""),[X,O]=s.useState(!1),[Y,F]=s.useState(!1);s.useEffect(()=>{var a;if(o){const n=o[S]||[],r=(n.length>0?Math.max(...n.map(i=>parseInt(i.NroRecibo,10)||0)):0)+1;N(i=>({...i,NroRecibo:r.toString()}));const c=[T,"ANULADO"];V([...new Set(((a=o.CuentasContables)==null?void 0:a.filter(i=>!c.includes(i.Categoria)).map(i=>i.Categoria))||[])]),K(o.Codigos||[])}},[o]),s.useEffect(()=>{if(!o||!t.NroRecibo){R(!1);return}const a=o[S].some(n=>n.NroRecibo.toString()===t.NroRecibo.toString());R(a)},[t.NroRecibo,o]),s.useEffect(()=>{const a=m?`${m}-${d}`:d;N(n=>({...n,NroDocumento:a}))},[m,d]),s.useEffect(()=>{const a=m?`${m}-${d}`:d;if(!o||!a||!d){w(!1);return}const n=o[S].some(r=>r.NroDocumento&&r.NroDocumento.toString()===a.toString());w(n)},[m,d,o]);const l=a=>{const{name:n,value:r,type:c,checked:i}=a.target,u=c==="checkbox"?i:r;N(x=>{const g={...x,[n]:u};if(n==="Anulado")i?(L(x.Categoria),U(x.Subcategoria),g.Categoria="ANULADO",g.Subcategoria="ANULADO"):(g.Categoria=P,g.Subcategoria=B);else if(n==="Categoria"){const oe=o.CuentasContables.filter(v=>v.Categoria===u).map(v=>v.Subcategoria);J([...new Set(oe)]),g.Subcategoria=""}return g})},Z=async()=>{const a=o.CuentasContables.find(r=>r.Categoria==="ANULADO"),n={...t,Anulado:!0,Categoria:"ANULADO",Subcategoria:"ANULADO",cuentaContableId:(a==null?void 0:a.id)||null,Importe:0,referencias:[]};await D({boletaData:n,garantiaData:null,garantiaActiva:!1}),alert("Recibo anulado y registrado con éxito."),I("/")},ee=()=>{if(["NroRecibo","NroDocumento","AlquiladoA","Instalacion","Categoria","Subcategoria"].some(r=>!t[r]||t[r]==="-")){alert("Complete todos los campos obligatorios (*).");return}const n=o.CuentasContables.find(r=>r.Categoria===t.Categoria&&r.Subcategoria===t.Subcategoria);if(!n){alert("La combinación Categoría/Subcategoría no es válida.");return}N(r=>({...r,cuentaContableId:n.id})),h(2)},ae=a=>{if(a.preventDefault(),p){alert("Error: El número de recibo ya está en uso.");return}if(f){alert("Error: El número de documento ya está en uso.");return}t.Anulado?Z():ee()},te=()=>{if(j.length===0){alert("Debe agregar al menos una referencia de pago.");return}h(3)},se=async()=>{const a=j.reduce((c,i)=>c+parseFloat(i.Importe||0),0),n={...t,Importe:a,referencias:j.map(({id:c,...i})=>i)};let r=null;if(A){if(C.length===0){alert("La garantía está activa pero no tiene referencias de pago.");return}const c=o.CuentasContables.find(u=>u.Categoria===T),i=C.reduce((u,x)=>u+parseFloat(x.Importe||0),0);r={...E,montoGarantia:i,cuentaContableId:c==null?void 0:c.id,referencias:C.map(({id:u,...x})=>x)}}await D({boletaData:n,garantiaData:r,garantiaActiva:A}),alert("¡Registro guardado con éxito!"),I("/")};return e.jsxs("div",{className:"flex h-screen overflow-hidden",children:[e.jsx(ie,{sidebarOpen:y,setSidebarOpen:k}),e.jsxs("div",{className:"relative flex flex-col flex-1 overflow-y-auto overflow-x-hidden",children:[e.jsx(le,{sidebarOpen:y,setSidebarOpen:k}),e.jsx("main",{className:"grow",children:e.jsx("div",{className:"px-4 sm:px-6 lg:px-8 py-8 w-full max-w-4xl mx-auto",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow-lg rounded-sm border border-gray-200 dark:border-gray-700 p-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-extrabold text-center mb-8",children:b===1?"AÑADIR BOLETA / FACTURA":b===2?"FASE 2: REGISTRAR PAGOS":"FASE 3: REGISTRAR GARANTÍA"}),b===1&&e.jsxs("form",{onSubmit:ae,children:[e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:["N° Recibo ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsx("input",{type:"text",name:"NroRecibo",onChange:l,value:t.NroRecibo,className:`form-input w-full dark:bg-gray-700 ${p?"border-red-500":""}`}),p&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:"Este número de recibo ya existe."})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("label",{className:"block text-sm font-medium dark:text-gray-300",children:["N° Documento ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsx("button",{type:"button",onClick:()=>O(!0),className:"text-xs text-indigo-500 hover:text-indigo-700 font-medium",children:"Gestionar"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("select",{onChange:a=>Q(a.target.value),value:m,className:`form-select dark:bg-gray-700 col-span-1 ${f?"border-red-500":""}`,children:[e.jsx("option",{value:"",children:"-"}),G.map(a=>e.jsx("option",{value:a.prefijo,children:a.prefijo},a.id))]}),e.jsx("input",{type:"text",onChange:a=>W(a.target.value),value:d,className:`form-input w-full dark:bg-gray-700 col-span-2 ${f?"border-red-500":""}`})]}),f&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:"Este número de documento ya existe."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Tipo Documento"}),e.jsxs("select",{name:"Documento",onChange:l,value:t.Documento,className:"form-select w-full dark:bg-gray-700",children:[e.jsx("option",{children:"Boleta"}),e.jsx("option",{children:"Factura"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Fecha"}),e.jsx("input",{type:"date",name:"Fecha",onChange:l,value:t.Fecha,className:"form-input w-full dark:bg-gray-700"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:["Alquilado a ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsx("input",{type:"text",name:"AlquiladoA",onChange:l,value:t.AlquiladoA,className:"form-input w-full dark:bg-gray-700"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("label",{className:"block text-sm font-medium dark:text-gray-300",children:["Instalación ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsx("button",{type:"button",onClick:()=>F(!0),className:"text-xs text-indigo-500 hover:text-indigo-700 font-medium",children:"Gestionar"})]}),e.jsxs("select",{name:"Instalacion",onChange:l,value:t.Instalacion,className:"form-select w-full dark:bg-gray-700",children:[e.jsx("option",{value:"",children:"Seleccione..."}),((o==null?void 0:o.Instalaciones)||[]).map(a=>e.jsx("option",{value:a.nombre,children:a.nombre},a.id))]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Descripción"}),e.jsx("textarea",{name:"Descripcion",rows:"2",onChange:l,value:t.Descripcion,className:"form-textarea w-full dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:["Categoría ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsxs("select",{name:"Categoria",onChange:l,value:t.Categoria,className:"form-select w-full dark:bg-gray-700",disabled:t.Anulado,children:[e.jsx("option",{value:"",children:"Seleccione..."}),H.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:["Subcategoría ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsxs("select",{name:"Subcategoria",onChange:l,value:t.Subcategoria,className:"form-select w-full dark:bg-gray-700",disabled:!t.Categoria||t.Anulado,children:[e.jsx("option",{value:"",children:"Seleccione..."}),z.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Cuenta Corriente"}),e.jsx("input",{type:"text",name:"CuentaCorriente",onChange:l,value:t.CuentaCorriente,className:"form-input w-full dark:bg-gray-700"})]}),e.jsxs("div",{className:"flex items-center md:col-start-2 mt-6",children:[e.jsx("input",{type:"checkbox",name:"Anulado",onChange:l,checked:t.Anulado,className:"form-checkbox"}),e.jsx("label",{className:"ml-2 text-sm text-gray-600 dark:text-gray-300",children:"Anular este recibo"})]})]}),e.jsx("div",{className:"flex justify-end gap-4 mt-8",children:e.jsx("button",{type:"submit",className:`btn ${t.Anulado?"bg-rose-500 hover:bg-rose-600":"bg-indigo-500 hover:bg-indigo-600"} text-white`,disabled:p||f,children:t.Anulado?"Guardar Anulación":"Siguiente (Fase de Pagos)"})})]}),b===2&&e.jsx(ce,{onBack:()=>h(1),onNext:te,referencias:j,setReferencias:M}),b===3&&e.jsx(de,{onBack:()=>h(2),onSave:se,garantiaActiva:A,setGarantiaActiva:$,garantiasData:E,handleGarantiasChange:a=>q(n=>({...n,[a.target.name]:a.target.value})),referenciasGarantia:C,setReferenciasGarantia:_})]})})}),e.jsx(me,{isVisible:X,onClose:()=>O(!1),codigos:G}),e.jsx(ue,{isVisible:Y,onClose:()=>F(!1),instalaciones:(o==null?void 0:o.Instalaciones)||[]})]})]})}export{Ae as default};
