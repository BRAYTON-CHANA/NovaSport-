import{r as n,u as Q,v as W,w as X,b as Y,o as Z,j as e}from"./index-g1PumTm4.js";import{S as $,H as ee}from"./Header-HN8A8OWr.js";import{F as ae,a as te}from"./Fase3Garantias-CnNAM-Yo.js";import{G as se}from"./GestionCodigosModal-D5Hp2JG-.js";import{G as oe}from"./GestionInstalacionesModal-D1O17sLp.js";import"./index.es-CE8XIQIh.js";import"./floating-ui.react-dom-CY_ef83B.js";import"./index-Ei0h8sv0.js";const R="INGRESOS POR FONDOS DE GARANTIA";function ge(){const[C,v]=n.useState(!1),{database:o,isLoading:E,actualizarBoletaCompleta:G}=Q(),g=W(),{id:x}=X(),[u,b]=n.useState(1),[t,f]=n.useState(null),[h,N]=n.useState([]),[j,y]=n.useState(!1),[S,A]=n.useState({descripcion:"",dirigidoA:"",cuentaCorriente:""}),[p,k]=n.useState([]),[T,B]=n.useState([]),[P,L]=n.useState([]),[I,M]=n.useState([]),[q,w]=n.useState(""),[_,F]=n.useState(""),[U,z]=n.useState(!1),[H,D]=n.useState(!1);n.useEffect(()=>{var a,r;if(o&&x){const s=o[Y].find(l=>l.id.toString()===x);if(s){const l=s.Fecha?new Date(s.Fecha).toISOString().slice(0,10):"";f({...s,Fecha:l}),N(s.referencias||[]);const m=(a=o[Z])==null?void 0:a.find(i=>{var O;return((O=i.boletaFacturaId)==null?void 0:O.toString())===x});if(m&&(y(!0),A(m),k(m.referencias||[])),s.NroDocumento){const i=s.NroDocumento.split("-");i.length>1?(w(i[0]),F(i.slice(1).join("-"))):(w(""),F(i[0]))}}else alert("No se encontró el documento a editar."),g("/gestion-boletas");const d=[R,"ANULADO"];B([...new Set(((r=o.CuentasContables)==null?void 0:r.filter(l=>!d.includes(l.Categoria)).map(l=>l.Categoria))||[])]),M(o.Codigos||[])}},[o,x,g]),n.useEffect(()=>{if(t!=null&&t.Categoria&&o){const a=o.CuentasContables.filter(r=>r.Categoria===t.Categoria).map(r=>r.Subcategoria);L([...new Set(a)]),a.includes(t.Subcategoria)||f(r=>({...r,Subcategoria:""}))}},[t==null?void 0:t.Categoria,o]);const c=a=>{const{name:r,value:s,type:d,checked:l}=a.target,m=d==="checkbox"?l:s;f(i=>({...i,[r]:m}))},V=()=>{if(["AlquiladoA","Instalacion","Categoria","Subcategoria"].some(s=>!t[s]||t[s]==="-")){alert("Complete todos los campos obligatorios.");return}const r=o.CuentasContables.find(s=>s.Categoria===t.Categoria&&s.Subcategoria===t.Subcategoria);if(!r){alert("La combinación Categoría/Subcategoría no es válida.");return}f(s=>({...s,cuentaContableId:r.id})),b(2)},J=()=>{if(h.length===0&&!t.Anulado){alert("Debe agregar al menos una referencia de pago.");return}b(3)},K=async()=>{const a=h.reduce((d,l)=>d+parseFloat(l.Importe||0),0),r={...t,Importe:a,referencias:h};let s=null;if(j){if(p.length===0){alert("La garantía está activa pero no tiene referencias de pago.");return}const d=o.CuentasContables.find(m=>m.Categoria===R),l=p.reduce((m,i)=>m+parseFloat(i.Importe||0),0);s={...S,montoGarantia:l,cuentaContableId:d==null?void 0:d.id,referencias:p}}await G({boletaData:r,garantiaData:s,garantiaActiva:j}),alert("¡Registro actualizado con éxito!"),g("/gestion-boletas")};return E||!t?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx("p",{children:"Cargando datos del documento..."})}):e.jsxs("div",{className:"flex h-screen overflow-hidden",children:[e.jsx($,{sidebarOpen:C,setSidebarOpen:v}),e.jsxs("div",{className:"relative flex flex-col flex-1 overflow-y-auto overflow-x-hidden",children:[e.jsx(ee,{sidebarOpen:C,setSidebarOpen:v}),e.jsx("main",{className:"grow",children:e.jsx("div",{className:"px-4 sm:px-6 lg:px-8 py-8 w-full max-w-4xl mx-auto",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow-lg rounded-sm border border-gray-200 dark:border-gray-700 p-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-extrabold text-center mb-8",children:u===1?"EDITAR BOLETA / FACTURA":u===2?"FASE 2: EDITAR PAGOS":"FASE 3: EDITAR GARANTÍA"}),u===1&&e.jsxs("form",{onSubmit:a=>{a.preventDefault(),V()},children:[e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"N° Recibo"}),e.jsx("input",{type:"text",value:t.NroRecibo,className:"form-input w-full dark:bg-gray-600 text-gray-400",readOnly:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"N° Documento"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("select",{value:q,className:"form-select dark:bg-gray-600 col-span-1 text-gray-400",disabled:!0,children:[e.jsx("option",{value:"",children:"-"}),I.map(a=>e.jsx("option",{value:a.prefijo,children:a.prefijo},a.id))]}),e.jsx("input",{type:"text",value:_,className:"form-input w-full dark:bg-gray-600 text-gray-400 col-span-2",readOnly:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Tipo Documento"}),e.jsxs("select",{name:"Documento",onChange:c,value:t.Documento,className:"form-select w-full dark:bg-gray-700",children:[e.jsx("option",{children:"Boleta"}),e.jsx("option",{children:"Factura"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Fecha"}),e.jsx("input",{type:"date",name:"Fecha",onChange:c,value:t.Fecha,className:"form-input w-full dark:bg-gray-700"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Alquilado a"}),e.jsx("input",{type:"text",name:"AlquiladoA",onChange:c,value:t.AlquiladoA,className:"form-input w-full dark:bg-gray-700"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("label",{className:"block text-sm font-medium dark:text-gray-300",children:"Instalación"}),e.jsx("button",{type:"button",onClick:()=>D(!0),className:"text-xs text-indigo-500 hover:text-indigo-700 font-medium",children:"Gestionar"})]}),e.jsxs("select",{name:"Instalacion",onChange:c,value:t.Instalacion,className:"form-select w-full dark:bg-gray-700",children:[e.jsx("option",{value:"",children:"Seleccione..."}),((o==null?void 0:o.Instalaciones)||[]).map(a=>e.jsx("option",{value:a.nombre,children:a.nombre},a.id))]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Descripción"}),e.jsx("textarea",{name:"Descripcion",rows:"2",onChange:c,value:t.Descripcion,className:"form-textarea w-full dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Categoría"}),e.jsxs("select",{name:"Categoria",onChange:c,value:t.Categoria,className:"form-select w-full dark:bg-gray-700",disabled:t.Anulado,children:[e.jsx("option",{value:"",children:"Seleccione..."}),T.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Subcategoría"}),e.jsxs("select",{name:"Subcategoria",onChange:c,value:t.Subcategoria,className:"form-select w-full dark:bg-gray-700",disabled:!t.Categoria||t.Anulado,children:[e.jsx("option",{value:"",children:"Seleccione..."}),P.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1 dark:text-gray-300",children:"Cuenta Corriente"}),e.jsx("input",{type:"text",name:"CuentaCorriente",onChange:c,value:t.CuentaCorriente,className:"form-input w-full dark:bg-gray-700"})]}),e.jsxs("div",{className:"flex items-center md:col-start-2 mt-6",children:[e.jsx("input",{type:"checkbox",name:"Anulado",onChange:c,checked:t.Anulado,className:"form-checkbox"}),e.jsx("label",{className:"ml-2 text-sm text-gray-600 dark:text-gray-300",children:"Anular este recibo"})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-8",children:[e.jsx("button",{type:"button",onClick:()=>g("/gestion-boletas"),className:"btn border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 text-gray-800 dark:text-gray-300",children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn bg-indigo-500 hover:bg-indigo-600 text-white",children:"Siguiente (Fase de Pagos)"})]})]}),u===2&&e.jsx(ae,{onBack:()=>b(1),onNext:J,referencias:h,setReferencias:N}),u===3&&e.jsx(te,{onBack:()=>b(2),onSave:K,garantiaActiva:j,setGarantiaActiva:y,garantiasData:S,handleGarantiasChange:a=>A(r=>({...r,[a.target.name]:a.target.value})),referenciasGarantia:p,setReferenciasGarantia:k})]})})}),e.jsx(se,{isVisible:U,onClose:()=>z(!1),codigos:I}),e.jsx(oe,{isVisible:H,onClose:()=>D(!1),instalaciones:(o==null?void 0:o.Instalaciones)||[]})]})]})}export{ge as default};
